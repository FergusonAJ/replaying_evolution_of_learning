#!/bin/bash

NUM_REPS=50

#REPLAY_SEEDS="93 221 299 327 422 458 476 477"
REPLAY_SEEDS="422"
declare -a DEPTH_MAP
DEPTH_MAP[93]="1010 960 910 860 810 760 710 660 610"
DEPTH_MAP[221]="1333 1283 1233 1183 1133 1083 1033 983 933"
DEPTH_MAP[299]="1443 1393 1343 1293 1243 1193 1143 1093 1043 993 943 893 843"
DEPTH_MAP[327]="1247 1197 1147 1097 1047 997 947 897 847"
DEPTH_MAP[422]="2990 2940 2890 2840 2790 2740 2690 2640 2590 2540 2490 2440 2390 2340 2290 2240 2190 2140 2090 2040 1990 1940 1890 1840 1790 1740 1690 1640 1590 1540 1490 1440 1390 1340 1290 1240 1190 1140 1040 990 940 890 840 790 740 690 640 590 540 490 440 390 340 290 240 190 140 90 40"
DEPTH_MAP[458]="1078 1028 978 928 878 828 778 728 678 628 578"
DEPTH_MAP[476]="2929 2879 2829 2779 2729 2679 2629 2579 2529 2479 2429 2379 2329 2279 2229 2179 2129 2079 2029 1979 1929 1879 1829 1779 1729 1679 1629 1579 1529 1479 1429 1379 1329 1279 1229 1179 1129 1079"
DEPTH_MAP[477]="1188 1138 1088 1038 988 938 888 838 788 738 688 638 588"
    
# Grab the experiment name
EXP_NAME=$(pwd | grep -oP "/\K[^/]+(?=/data|/data/scripts)")

# Grab global config variables
REPO_ROOT_DIR=$(pwd | grep -oP ".+/(?=experiments/)")
source ${REPO_ROOT_DIR}/config_global.sh

# Calculate directories to pass to R script
SCRATCH_REP_DIR=${SCRATCH_ROOT_DIR}/${EXP_NAME}/reps
OUTPUT_DIR=$(pwd | grep -oP ".+/${EXP_NAME}/data")
SCRIPT_DIR=${OUTPUT_DIR}/scripts

for REPLAY_SEED in ${REPLAY_SEEDS}
do
    echo "Starting seed: ${REPLAY_SEED}"
    for REPLAY_DEPTH in ${DEPTH_MAP[REPLAY_SEED]}
    do
        echo "  Depth: ${REPLAY_DEPTH}"
        REPLAY_SCRATCH_REP_DIR=${SCRATCH_REP_DIR}/${REPLAY_SEED}/replays/${REPLAY_DEPTH}
        REPLAY_OUTPUT_DIR=${OUTPUT_DIR}/reps/${REPLAY_SEED}/replays/${REPLAY_DEPTH}
        mkdir -p ${REPLAY_OUTPUT_DIR}
        echo ""
        echo "Pulling data from: ${REPLAY_SCRATCH_REP_DIR}"
        echo "Saving data to: ${REPLAY_OUTPUT_DIR}"
        echo ""
        Rscript ${SCRIPT_DIR}/combine_final_dominant_data.R ${REPLAY_SCRATCH_REP_DIR} ${REPLAY_OUTPUT_DIR} ${NUM_REPS}
    done
    echo "----------------"
done
