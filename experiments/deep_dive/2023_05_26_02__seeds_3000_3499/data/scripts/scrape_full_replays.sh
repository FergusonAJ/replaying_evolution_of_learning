#!/bin/bash

NUM_REPS=50

#declare -a DEPTH_MAP
#REPLAY_SEEDS="128 156 184 223 278 365 406 426 485"
#DEPTH_MAP[128]="3315 3265 3215 3165 3115"
#DEPTH_MAP[156]="1780 1730 1680 1630 1580"
#DEPTH_MAP[184]="1761 1711 1661 1611 1561"
#DEPTH_MAP[223]="1524 1474 1424 1374 1324"
#DEPTH_MAP[278]="1402 1352 1302 1252 1202"
#DEPTH_MAP[365]="1430 1380 1330 1280 1230"
#DEPTH_MAP[406]="905 855 805 755 705"
#DEPTH_MAP[426]="1694 1644 1594 1544 1494"
#DEPTH_MAP[485]="1365 1315 1265 1215 1165"

#REPLAY_SEEDS="128 156 184 223 365 406 426"
#declare -a DEPTH_MAP
#DEPTH_MAP[128]="3065 3015 2965 2915 2865 2815"
#DEPTH_MAP[156]="1530 1480 1430 1380 1330 1280"
#DEPTH_MAP[184]="1511 1461 1411 1361 1311 1261"
#DEPTH_MAP[223]="1274 1224 1174 1124 1074 1024"
#DEPTH_MAP[365]="1180 1130 1080 1030 980 930"
#DEPTH_MAP[406]="655 605 555 505 455 405"
#DEPTH_MAP[426]="1444 1394 1344 1294 1244 1194"

#REPLAY_SEEDS="156 184 223 426"
#declare -a DEPTH_MAP
#DEPTH_MAP[156]="1230 1180 1130 1080 1030 980"
#DEPTH_MAP[184]="1211 1161 1111 1061 1011 961"
#DEPTH_MAP[223]="974 924 874 824 774 724"
#DEPTH_MAP[426]="1144 1094 1044 994 944 894"

#REPLAY_SEEDS="184 223 426"
#declare -a DEPTH_MAP
#DEPTH_MAP[184]="911 861 811 761 711 661"
#DEPTH_MAP[223]="674 624 574 524 474 424"
#DEPTH_MAP[426]="844 794 744 694 644 594"

REPLAY_SEEDS="223 426"
declare -a DEPTH_MAP
DEPTH_MAP[223]="374 324 274 224 174 124"
DEPTH_MAP[426]="544 494 444 394 344 294"
    
# Grab the experiment name
EXP_NAME=$(pwd | grep -oP "/\K[^/]+(?=/data|/data/scripts)")

# Grab global config variables
REPO_ROOT_DIR=$(pwd | grep -oP ".+/(?=experiments/)")
source ${REPO_ROOT_DIR}/config_global.sh

# Calculate directories to pass to R script
SCRATCH_REP_DIR=${SCRATCH_ROOT_DIR}/${EXP_NAME}/reps
OUTPUT_DIR=$(pwd | grep -oP ".+/${EXP_NAME}/data")
SCRIPT_DIR=${OUTPUT_DIR}/scripts

for REPLAY_SEED in ${REPLAY_SEEDS}
do
    echo "Starting seed: ${REPLAY_SEED}"
    for REPLAY_DEPTH in ${DEPTH_MAP[REPLAY_SEED]}
    do
        echo "  Depth: ${REPLAY_DEPTH}"
        REPLAY_SCRATCH_REP_DIR=${SCRATCH_REP_DIR}/${REPLAY_SEED}/full_replays/${REPLAY_DEPTH}
        REPLAY_OUTPUT_DIR=${OUTPUT_DIR}/reps/${REPLAY_SEED}/full_replays/${REPLAY_DEPTH}
        mkdir -p ${REPLAY_OUTPUT_DIR}
        echo ""
        echo "Pulling data from: ${REPLAY_SCRATCH_REP_DIR}"
        echo "Saving data to: ${REPLAY_OUTPUT_DIR}"
        echo ""
        Rscript ${SCRIPT_DIR}/combine_final_dominant_data.R ${REPLAY_SCRATCH_REP_DIR} ${REPLAY_OUTPUT_DIR} ${NUM_REPS}
    done
    echo "----------------"
done
